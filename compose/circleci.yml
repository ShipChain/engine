version: '2.1'
services:

  redis_db:
    image: redis
    expose:
    - '6379'
    healthcheck:
      test: ["CMD", "redis-cli","ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    command: >
      --requirepass redis_pass --appendonly yes

  geth-poa:
    image: shipchain/geth-poa
    healthcheck:
      test: "nc -z localhost 8545"
      timeout: 10s
      interval: 10s
      retries: 3
    expose:
      - '8545'

  sftp:
    image: atmoz/sftp
    expose:
      - '22'
    command: shipchain_user:shipchain_password:::upload

  minio:
    image: minio/minio
    command: server /data
    expose:
      - "9000"
    healthcheck:
      test: "nc -z localhost 9000"
      timeout: 10s
      interval: 10s
      retries: 3
    environment:
      MINIO_ACCESS_KEY: myMinioAccessKey
      MINIO_SECRET_KEY: myMinioSecretKey

  psql:
    image: sameersbn/postgresql:9.6-2
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "engine"]
      interval: 1s
      timeout: 3s
      retries: 30
    expose:
      - '5432'
    environment:
    - DB_NAME=engine
    - DB_PASS=engine
    - DB_USER=engine
    - DB_EXTENSION="uuid-ossp"

  rpc:
    extends:
      service: engine-node
      file: build.yml
    command: sleep infinity
    links:
      - redis_db
      - geth-poa
      - sftp
      - minio
      - psql
    depends_on:
      redis_db:
        condition: service_healthy
      geth-poa:
        condition: service_healthy
      minio:
        condition: service_healthy
      psql:
        condition: service_healthy
    environment:
      - ENV
      - GETH_NODE
      - SERVICE=engine-app
      - SFTP_DRIVER_TESTS
      - SFTP_HOST=sftp
      - SFTP_PORT=22
      - SFTP_USER=shipchain_user
      - SFTP_PASS=shipchain_password
      - S3_DRIVER_TESTS
      - S3_BUCKET=my-test-bucket
      - S3_ENDPOINT=http://minio:9000
      - S3_ACCESSKEY=myMinioAccessKey
      - S3_SECRETKEY=myMinioSecretKey
      - LOCAL_SECRET_KEY
      - REDIS_URL
      - CONTRACT_FIXTURES_URL
